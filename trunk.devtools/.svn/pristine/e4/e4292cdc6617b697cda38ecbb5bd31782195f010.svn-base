#!/bin/bash

print_usage()
{
  echo "Usage: $(basename $0) [-n N] [-e]"
  echo "  View logs generated by \`mk' tool in \$(wcroot)/.buildlogs/"
  echo "  Options:"
  echo "    -n N : Show Nth latest log. Numbering starts with 1, default is 1 (latest)."
  echo "    -e   : Show errors / warnings only."
  exit 0
}

erronly=0
offset=1

while getopts en:h opt; do
  [ "$opt" = "n" ] && offset=$OPTARG
  [ "$opt" = "e" ] && erronly=1
  [ "$opt" = "h" ] && print_usage
done

wcroot="$(wcroot)"

if [ -z "$wcroot" ]; then
  echo Error: not within SVN repository
  exit 1
fi


logfile="$(ls "$wcroot/.buildlogs" | sort -r | sed -n "${offset}p")"

if [ -z "$logfile" ]; then
  echo Error: there is no ${offset}th log in "$wcroot/.buildlogs"
  exit 1
fi

cmd="cat '$wcroot/.buildlogs/$logfile' "

[ $erronly -eq 1 ] && cmd+="| egrep -C4 '\berror\b|\bwarning\b'"

eval "$cmd | paint_build_log | less -r"
